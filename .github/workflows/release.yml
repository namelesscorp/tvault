name: Build & Release (Tauri)

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build:
        strategy:
            matrix:
                include:
                    # macOS
                    - os: macos-14
                      target: aarch64-apple-darwin
                      artifact_name: tvault-client_aarch64-apple-darwin
                    - os: macos-14
                      target: x86_64-apple-darwin
                      artifact_name: tvault-client_x86_64-apple-darwin

                    # Windows
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact_name: tvault-client_x86_64-pc-windows-msvc
                    - os: windows-latest
                      target: i686-pc-windows-msvc
                      artifact_name: tvault-client_i686-pc-windows-msvc

                    # Linux x64
                    # - os: ubuntu-22.04
                    #   target: x86_64-unknown-linux-gnu
                    #   artifact_name: tvault-client_x86_64-unknown-linux-gnu

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "yarn"

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Cache Cargo
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      src-tauri/target
                  key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

            - name: Install deps
              run: yarn --frozen-lockfile

            - name: Select Xcode
              if: startsWith(matrix.target, 'aarch64-apple-') || startsWith(matrix.target, 'x86_64-apple-')
              run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

            - name: Install NSIS
              if: matrix.os == 'windows-latest'
              run: choco install nsis -y

            - name: Build (macOS signed & notarized)
              if: startsWith(matrix.target, 'aarch64-apple-') || startsWith(matrix.target, 'x86_64-apple-')
              env:
                  APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
                  APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
              run: |
                  yarn tauri build --target ${{ matrix.target }}

            - name: Build (other)
              if: ${{ !(startsWith(matrix.target, 'aarch64-apple-') || startsWith(matrix.target, 'x86_64-apple-')) }}
              env:
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
              run: |
                  yarn tauri build --target ${{ matrix.target }}

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}
                  path: |
                      src-tauri/target/${{ matrix.target }}/release/bundle/**
                  if-no-files-found: error

    release:
        needs: build
        runs-on: ubuntu-22.04
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      dist/**/*
                  draft: false
                  prerelease: ${{ contains(github.ref_name, '-') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Build updater.json
              run: |
                  sudo apt-get update && sudo apt-get install -y jq
                  VERSION=${GITHUB_REF#refs/tags/}

                  MAC_ARM_JSON="dist/tvault-client_aarch64-apple-darwin/**/updater.json"
                  MAC_X64_JSON="dist/tvault-client_x86_64-apple-darwin/**/updater.json"
                  WIN_X64_JSON="dist/tvault-client_x86_64-pc-windows-msvc/**/updater.json"
                  WIN_X86_JSON="dist/tvault-client_i686-pc-windows-msvc/**/updater.json"

                  SIG_MAC_ARM=$(cat $(ls $MAC_ARM_JSON) | jq -r '.platforms["darwin-aarch64"].signature')
                  SIG_MAC_X64=$(cat $(ls $MAC_X64_JSON) | jq -r '.platforms["darwin-x86_64"].signature')
                  SIG_WIN_X64=$(cat $(ls $WIN_X64_JSON) | jq -r '.platforms["windows-x86_64"].signature')
                  SIG_WIN_X86=$(cat $(ls $WIN_X86_JSON) | jq -r '.platforms["windows-i686"].signature')

                  mkdir -p public
                  cat > public/updater.json << EOF
                  {
                    "version": "${VERSION}",
                    "notes": "Automatic update",
                    "pub_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
                    "platforms": {
                      "darwin-aarch64": {
                        "signature": "${SIG_MAC_ARM}",
                        "url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/tvault-client_${VERSION}_aarch64-apple-darwin.tar.gz"
                      },
                      "darwin-x86_64": {
                        "signature": "${SIG_MAC_X64}",
                        "url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/tvault-client_${VERSION}_x86_64-apple-darwin.tar.gz"
                      },
                      "windows-x86_64": {
                        "signature": "${SIG_WIN_X64}",
                        "url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/tvault-client_${VERSION}_x86_64-pc-windows-msvc.exe"
                      },
                      "windows-i686": {
                        "signature": "${SIG_WIN_X86}",
                        "url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/tvault-client_${VERSION}_i686-pc-windows-msvc.exe"
                      }
                    }
                  }
                  EOF

            - name: Commit updated updater.json
              run: |
                  if [ -f public/updater.json ]; then
                    git config --local user.email "action@github.com"
                    git config --local user.name "GitHub Action"
                    git pull --rebase
                    git add public/updater.json
                    git commit -m "Update updater.json for ${GITHUB_REF#refs/tags/}" || true
                    git push || true
                  fi
